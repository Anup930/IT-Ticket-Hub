<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Dashboard - IT Ticket Hub</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    body { overflow-x: hidden; background-color: #f4f6f9; }

    /* Sidebar & Layout Styles */
    #wrapper { display: flex; width: 100%; height: 100vh; }
    #sidebar-wrapper { min-height: 100vh; width: 250px; background-color: #212529; color: white; transition: margin 0.25s ease-out; flex-shrink: 0; }
    .sidebar-heading { padding: 1.5rem; font-size: 1.2rem; font-weight: bold; background-color: #1c1f23; border-bottom: 1px solid #444; }
    .list-group-item { border: none; padding: 15px 20px; background: transparent; color: #cfd2d6; cursor: pointer; }
    .list-group-item:hover, .list-group-item.active { background-color: #0d6efd; color: white; }
    #page-content-wrapper { flex: 1; overflow-y: auto; width: 100%; }
    
    /* Mobile Toggle */
    #wrapper.toggled #sidebar-wrapper { margin-left: -250px; }
    @media (max-width: 768px) {
      #sidebar-wrapper { margin-left: -250px; position: fixed; z-index: 1000; height: 100%; }
      #wrapper.toggled #sidebar-wrapper { margin-left: 0; }
      #overlay { display: none; position: fixed; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; }
      #wrapper.toggled #overlay { display: block; }
    }

    /* Clickable Row Styles */
    .clickable-row { cursor: pointer; transition: background 0.2s; }
    .clickable-row:hover { background-color: #e9ecef !important; }

    /* Modal Styles */
    .timeline-box { background: #f8f9fa; border-radius: 8px; padding: 15px; border-left: 4px solid #0d6efd; margin-bottom: 15px; }
    .log-box { background: #212529; color: #00ff00; font-family: monospace; padding: 15px; border-radius: 5px; max-height: 200px; overflow-y: auto; font-size: 0.85rem; }
  </style>
</head>
<body>

  <div class="d-flex" id="wrapper">
    <div id="overlay" onclick="toggleSidebar()"></div>

    <div id="sidebar-wrapper">
      <div class="sidebar-heading text-warning"><i class="fas fa-ticket-alt"></i> IT Ticket Hub</div>
      <div class="list-group list-group-flush mt-3">
        <a id="menu-all" class="list-group-item active" onclick="switchView('All')"><i class="fas fa-list me-2"></i> My Tickets (All)</a>
        <a id="menu-open" class="list-group-item" onclick="switchView('Open')"><i class="fas fa-folder-open me-2"></i> Open Tickets</a>
        <a class="list-group-item" data-bs-toggle="modal" data-bs-target="#newTicketModal"><i class="fas fa-plus-circle me-2"></i> New Ticket</a>
        <a class="list-group-item text-danger mt-4" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> Logout</a>
      </div>
      <div class="mt-auto p-3 text-center text-secondary border-top border-secondary" style="font-size: 0.8rem;">
        Logged in as:<br><span id="displayUserId" class="text-white">User</span>
      </div>
    </div>

    <div id="page-content-wrapper">
      <nav class="navbar navbar-light bg-white shadow-sm px-4 py-3 mb-4">
        <button class="btn btn-outline-dark me-3" id="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <span class="fw-bold text-secondary fs-5">Dashboard</span>
      </nav>

      <div class="container-fluid px-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3 class="text-dark" id="page-title">My Tickets</h3>
          <button class="btn btn-success shadow-sm" data-bs-toggle="modal" data-bs-target="#newTicketModal"><i class="fas fa-paper-plane me-2"></i>Raise Ticket</button>
        </div>

        <div class="card shadow-sm border-0 rounded-3">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th class="ps-4">ID</th>
                    <th>Subject</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Date Created</th>
                  </tr>
                </thead>
                <tbody id="ticketBody">
                  <tr><td colspan="5" class="text-center py-5 text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Loading tickets...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="ticketDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title" id="modalTicketTitle">Ticket Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          
          <div class="timeline-box">
            <div class="row text-center">
              <div class="col-md-4 mb-2">
                <small class="text-muted">Created On</small><br>
                <strong id="detailCreated"></strong>
              </div>
              <div class="col-md-4 mb-2">
                <small class="text-muted">Closed On</small><br>
                <strong id="detailClosed" class="text-primary"></strong>
              </div>
              <div class="col-md-4 mb-2">
                <small class="text-muted">Resolved By</small><br>
                <strong id="detailClosedBy"></strong>
              </div>
            </div>
            <hr>
            <div class="text-center">
              <span class="badge bg-warning text-dark fs-6">Time Taken: <span id="detailDuration"></span></span>
            </div>
          </div>

          <h6 class="fw-bold">Description:</h6>
          <div class="p-3 bg-light rounded mb-3 border">
            <p id="detailDesc" class="mb-0 text-secondary">No description.</p>
          </div>

          <h6 class="fw-bold">Updates & Logs:</h6>
          <div class="log-box" id="detailLogs">
            </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="newTicketModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Create New Ticket</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="createForm">
            <div class="mb-3">
              <label class="form-label fw-bold">Subject</label>
              <select id="subject" class="form-select">
                <option value="Hardware Issue">Hardware Issue</option>
                <option value="Software Issue">Software Issue</option>
                <option value="Network/Internet">Network/Internet</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">Priority</label>
              <select id="priority" class="form-select">
                <option value="Low">Low</option>
                <option value="Medium" selected>Medium</option>
                <option value="High">High</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">Description</label>
              <textarea id="desc" class="form-control" rows="4" required></textarea>
            </div>
            <div class="d-grid"><button type="submit" id="submitBtn" class="btn btn-primary">Submit Ticket</button></div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // *** API URL HERE ***
    const API_URL = "https://script.google.com/macros/s/AKfycbwph1zPPyg0WfW2V_Jq-umvIDC3on6NlgSGpmCbz1V5fBfL3HAPClp9PL2cc-HP1xii/exec";
    
    const userId = sessionStorage.getItem('userId');
    if(!userId) window.location.href = 'index.html';
    document.getElementById('displayUserId').innerText = userId;

    let allTickets = [];

    window.onload = function() { fetchTickets(); };

    function toggleSidebar() { document.getElementById("wrapper").classList.toggle("toggled"); }

    function fetchTickets() {
      fetch(`${API_URL}?action=getTickets&userId=${userId}&role=User`)
        .then(res => res.json())
        .then(data => {
          allTickets = data || [];
          renderTickets('All');
        })
        .catch(err => {
          console.error(err);
          document.getElementById('ticketBody').innerHTML = '<tr><td colspan="5" class="text-center text-danger py-4">Error loading data.</td></tr>';
        });
    }

    function switchView(viewType) {
      document.getElementById('menu-all').classList.remove('active');
      document.getElementById('menu-open').classList.remove('active');

      if (viewType === 'All') {
        document.getElementById('menu-all').classList.add('active');
        document.getElementById('page-title').innerText = "My Tickets (All)";
      } else {
        document.getElementById('menu-open').classList.add('active');
        document.getElementById('page-title').innerText = "Open Tickets";
      }
      renderTickets(viewType);
    }

    function renderTickets(filter) {
      const tbody = document.getElementById('ticketBody');
      tbody.innerHTML = '';
      
      let filteredData = allTickets;
      if (filter === 'Open') {
        filteredData = allTickets.filter(t => t.status !== 'Resolved' && t.status !== 'Closed');
      }

      if (filteredData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center py-5 text-muted">No ${filter === 'Open' ? 'open' : ''} tickets found.</td></tr>`;
        return;
      }

      filteredData.forEach(t => {
        let badgeClass = 'bg-secondary';
        if(t.status === 'New') badgeClass = 'bg-primary';
        if(t.status === 'Resolved' || t.status === 'Closed') badgeClass = 'bg-success';
        if(t.status === 'Pending') badgeClass = 'bg-warning text-dark';
        let priorityColor = t.priority === 'High' ? 'text-danger fw-bold' : 'text-dark';

        // Add onclick event to open modal
        let row = `
          <tr class="clickable-row" onclick="openTicketDetail('${t.id}')">
            <td class="ps-4 fw-bold text-primary"><small>${t.id}</small></td>
            <td>${t.subject}</td>
            <td class="${priorityColor}">${t.priority || 'Medium'}</td>
            <td><span class="badge ${badgeClass} rounded-pill">${t.status || 'New'}</span></td>
            <td class="text-muted"><small>${t.date}</small></td>
          </tr>
        `;
        tbody.innerHTML += row;
      });
    }

    // --- NEW: Open Modal Function ---
    function openTicketDetail(ticketId) {
      // Find the ticket object
      const ticket = allTickets.find(t => t.id === ticketId);
      if(!ticket) return;

      // Populate Modal Fields
      document.getElementById('modalTicketTitle').innerText = `${ticket.id} - ${ticket.status}`;
      document.getElementById('detailCreated').innerText = ticket.fullCreated;
      document.getElementById('detailClosed').innerText = ticket.fullClosed;
      document.getElementById('detailClosedBy').innerText = ticket.closedBy;
      document.getElementById('detailDuration').innerText = ticket.duration;
      document.getElementById('detailDesc').innerText = ticket.desc || "No description provided.";
      
      // Logs formating
      const logs = ticket.logs ? ticket.logs.replace(/\n/g, '<br>') : "No updates yet.";
      document.getElementById('detailLogs').innerHTML = logs;

      // Show Modal
      const modal = new bootstrap.Modal(document.getElementById('ticketDetailModal'));
      modal.show();
    }

    // Create Ticket Logic
    document.getElementById('createForm').addEventListener('submit', function(e){
      e.preventDefault();
      const btn = document.getElementById('submitBtn');
      const oldText = btn.innerText;
      btn.disabled = true; btn.innerText = "Submitting...";

      const payload = {
        action: 'createTicket',
        userId: userId,
        subject: document.getElementById('subject').value,
        priority: document.getElementById('priority').value,
        desc: document.getElementById('desc').value
      };

      fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) })
      .then(res => res.json())
      .then(data => {
        if(data.success) {
          bootstrap.Modal.getInstance(document.getElementById('newTicketModal')).hide();
          document.getElementById('createForm').reset();
          alert("Ticket Created!");
          fetchTickets();
        } else { alert("Error: " + data.message); }
      })
      .catch(() => alert("Server Error"))
      .finally(() => { btn.disabled = false; btn.innerText = oldText; });
    });

    function logout() {
      if(confirm("Logout?")) { sessionStorage.clear(); window.location.href = 'index.html'; }
    }
  </script>
</body>
</html>
