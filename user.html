<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Dashboard - IT Ticket Hub</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    body { overflow-x: hidden; background-color: #f4f6f9; }

    /* --- SIDEBAR STYLES --- */
    #wrapper { display: flex; width: 100%; height: 100vh; }
    #sidebar-wrapper {
      min-height: 100vh; width: 250px; background-color: #212529; color: white;
      transition: margin 0.25s ease-out; flex-shrink: 0;
    }
    .sidebar-heading { padding: 1.5rem 1.25rem; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid #444; background-color: #1c1f23; }
    
    .list-group-item { border: none; padding: 15px 20px; background-color: transparent; color: #cfd2d6; }
    .list-group-item:hover { background-color: #343a40; color: #fff; cursor: pointer; }
    .list-group-item.active { background-color: #0d6efd; color: white; font-weight: bold; border-left: 4px solid #fff; }
    .list-group-item i { width: 25px; }

    /* --- PAGE CONTENT --- */
    #page-content-wrapper { flex: 1; overflow-y: auto; width: 100%; }
    .top-navbar { background-color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }

    /* Badges */
    .badge-status-new { background-color: #3b82f6; } 
    .badge-status-resolved { background-color: #10b981; } 
    .badge-status-pending { background-color: #f59e0b; }

    /* Clickable Row */
    .clickable-row { cursor: pointer; transition: background 0.2s; }
    .clickable-row:hover { background-color: #e9ecef !important; }

    /* Mobile Toggle */
    #wrapper.toggled #sidebar-wrapper { margin-left: -250px; }
    @media (max-width: 768px) {
      #sidebar-wrapper { margin-left: -250px; position: fixed; z-index: 1000; height: 100%; }
      #wrapper.toggled #sidebar-wrapper { margin-left: 0; }
      #overlay { display: none; position: fixed; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; }
      #wrapper.toggled #overlay { display: block; }
    }

    /* --- WHATSAPP CHAT STYLES --- */
    .timeline-box { background: #f8f9fa; border-radius: 8px; padding: 10px; border: 1px solid #e9ecef; margin-bottom: 15px; font-size: 0.9rem; }
    
    .chat-container {
      background-color: #e5ddd5; /* WhatsApp BG */
      background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png"); /* Optional Doodle BG */
      border-radius: 8px;
      height: 350px;
      overflow-y: auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      border: 1px solid #ddd;
    }

    .chat-bubble {
      max-width: 80%;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.9rem;
      position: relative;
      word-wrap: break-word;
      display: flex;
      flex-direction: column;
    }

    /* Admin Messages (Left - White) */
    .chat-left {
      align-self: flex-start;
      background-color: #ffffff;
      border-top-left-radius: 0;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    /* User Messages (Right - Green) */
    .chat-right {
      align-self: flex-end;
      background-color: #dcf8c6;
      border-top-right-radius: 0;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .chat-meta {
      font-size: 0.7rem;
      color: #999;
      text-align: right;
      margin-top: 4px;
    }

    .chat-input-area {
      display: flex;
      gap: 10px;
      padding-top: 15px;
      border-top: 1px solid #eee;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <div class="d-flex" id="wrapper">
    <div id="overlay" onclick="toggleSidebar()"></div>

    <div id="sidebar-wrapper">
      <div class="sidebar-heading text-warning"><i class="fas fa-ticket-alt"></i> IT Ticket Hub</div>
      <div class="list-group list-group-flush mt-3">
        <a id="menu-all" class="list-group-item active" onclick="switchView('All')"><i class="fas fa-list me-2"></i> My Tickets (All)</a>
        <a id="menu-open" class="list-group-item" onclick="switchView('Open')"><i class="fas fa-folder-open me-2"></i> Open Tickets</a>
        <a class="list-group-item" data-bs-toggle="modal" data-bs-target="#newTicketModal"><i class="fas fa-plus-circle me-2"></i> New Ticket</a>
        <a class="list-group-item text-danger mt-4" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> Logout</a>
      </div>
      <div class="mt-auto p-3 text-center text-secondary border-top border-secondary" style="font-size: 0.8rem;">
        Logged in as:<br><span id="displayUserId" class="text-white">User</span>
      </div>
    </div>

    <div id="page-content-wrapper">
      <nav class="top-navbar">
        <button class="btn btn-outline-dark" id="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <div class="fw-bold text-secondary">Dashboard</div>
      </nav>

      <div class="container-fluid p-4">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3 class="text-dark" id="page-title">My Tickets</h3>
          <button class="btn btn-success shadow-sm" data-bs-toggle="modal" data-bs-target="#newTicketModal">
            <i class="fas fa-paper-plane me-2"></i>Raise Ticket
          </button>
        </div>

        <div class="card shadow-sm border-0 rounded-3">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th class="ps-4">ID</th>
                    <th>Subject</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Date</th>
                  </tr>
                </thead>
                <tbody id="ticketBody">
                  <tr><td colspan="5" class="text-center py-5 text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Loading tickets...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="modal fade" id="ticketDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-dark text-white">
          <h5 class="modal-title" id="modalTicketTitle">Ticket Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          
          <div class="timeline-box">
            <div class="row text-center">
              <div class="col-4">
                <small class="text-muted">Created</small><br>
                <strong id="detailCreated"></strong>
              </div>
              <div class="col-4">
                <small class="text-muted">Status</small><br>
                <strong id="detailStatus" class="text-primary"></strong>
              </div>
              <div class="col-4">
                <small class="text-muted">Duration</small><br>
                <span class="badge bg-warning text-dark" id="detailDuration"></span>
              </div>
            </div>
          </div>

          <h6 class="fw-bold text-secondary"><i class="fas fa-align-left me-2"></i>Description</h6>
          <div class="p-3 bg-light rounded mb-3 border">
            <p id="detailDesc" class="mb-0 text-dark small"></p>
          </div>

          <h6 class="fw-bold text-secondary"><i class="fas fa-comments me-2"></i>Conversation</h6>
          
          <div id="chatWindow" class="chat-container">
            </div>

          <div class="chat-input-area" id="chatInputSection">
            <input type="text" id="chatMessage" class="form-control" placeholder="Type a message..." onkeypress="handleEnter(event)">
            <button class="btn btn-success" onclick="sendMessage()">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
          <div id="closedMessage" class="alert alert-secondary mt-3 text-center d-none">
            <i class="fas fa-lock me-2"></i> This ticket is closed. You cannot reply.
          </div>

        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="newTicketModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Create New Ticket</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="createForm">
            <div class="mb-3">
              <label class="form-label fw-bold">Subject</label>
              <select id="subject" class="form-select">
                <option value="Hardware Issue">Hardware Issue</option>
                <option value="Software Issue">Software Issue</option>
                <option value="Network/Internet">Network/Internet</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">Priority</label>
              <select id="priority" class="form-select">
                <option value="Low">Low</option>
                <option value="Medium" selected>Medium</option>
                <option value="High">High</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">Description</label>
              <textarea id="desc" class="form-control" rows="4" required></textarea>
            </div>
            <div class="d-grid"><button type="submit" id="submitBtn" class="btn btn-primary">Submit Ticket</button></div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // *** PASTE YOUR WEB APP URL HERE ***
    const API_URL = "https://script.google.com/macros/s/AKfycbwph1zPPyg0WfW2V_Jq-umvIDC3on6NlgSGpmCbz1V5fBfL3HAPClp9PL2cc-HP1xii/exec";
    
    const userId = sessionStorage.getItem('userId');
    if(!userId) window.location.href = 'index.html';
    document.getElementById('displayUserId').innerText = userId;

    let allTickets = [];
    let currentTicketId = null;

    // Load Data
    window.onload = function() { fetchTickets(); };

    function toggleSidebar() { document.getElementById("wrapper").classList.toggle("toggled"); }

    // --- FETCH DATA ---
    function fetchTickets() {
      return fetch(`${API_URL}?action=getTickets&userId=${userId}&role=User`)
        .then(res => res.json())
        .then(data => {
          allTickets = data || [];
          // Refresh current view
          const currentView = document.getElementById('menu-open').classList.contains('active') ? 'Open' : 'All';
          renderTickets(currentView);
        })
        .catch(err => {
          console.error(err);
          document.getElementById('ticketBody').innerHTML = '<tr><td colspan="5" class="text-center text-danger py-4">Error loading data.</td></tr>';
        });
    }

    // --- VIEW SWITCHING ---
    function switchView(viewType) {
      document.getElementById('menu-all').classList.remove('active');
      document.getElementById('menu-open').classList.remove('active');

      if (viewType === 'All') {
        document.getElementById('menu-all').classList.add('active');
        document.getElementById('page-title').innerText = "My Tickets (All)";
      } else {
        document.getElementById('menu-open').classList.add('active');
        document.getElementById('page-title').innerText = "Open Tickets";
      }
      renderTickets(viewType);
    }

    // --- RENDER TABLE ---
    function renderTickets(filter) {
      const tbody = document.getElementById('ticketBody');
      tbody.innerHTML = '';
      
      let filteredData = allTickets;
      if (filter === 'Open') {
        filteredData = allTickets.filter(t => t.status !== 'Resolved' && t.status !== 'Closed');
      }

      if (filteredData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center py-5 text-muted">No ${filter === 'Open' ? 'open' : ''} tickets found.</td></tr>`;
        return;
      }

      filteredData.forEach(t => {
        let badgeClass = 'bg-secondary';
        if(t.status === 'New') badgeClass = 'badge-status-new';
        if(t.status === 'Resolved' || t.status === 'Closed') badgeClass = 'badge-status-resolved';
        if(t.status === 'Pending') badgeClass = 'badge-status-pending';
        let priorityColor = t.priority === 'High' ? 'text-danger fw-bold' : 'text-dark';

        let row = `
          <tr class="clickable-row" onclick="openTicketDetail('${t.id}')">
            <td class="ps-4 fw-bold text-primary"><small>${t.id}</small></td>
            <td>${t.subject}</td>
            <td class="${priorityColor}">${t.priority || 'Medium'}</td>
            <td><span class="badge ${badgeClass} rounded-pill">${t.status || 'New'}</span></td>
            <td class="text-muted"><small>${t.date}</small></td>
          </tr>
        `;
        tbody.innerHTML += row;
      });
    }

    // --- OPEN DETAIL MODAL (CHAT) ---
    function openTicketDetail(ticketId) {
      currentTicketId = ticketId;
      const ticket = allTickets.find(t => t.id === ticketId);
      if(!ticket) return;

      document.getElementById('modalTicketTitle').innerText = `${ticket.id}`;
      document.getElementById('detailCreated').innerText = ticket.fullCreated;
      document.getElementById('detailStatus').innerText = ticket.status;
      document.getElementById('detailDuration').innerText = ticket.duration || "Active";
      document.getElementById('detailDesc').innerText = ticket.desc || "No description provided.";
      
      // Toggle Input based on Status
      const isClosed = (ticket.status === 'Resolved' || ticket.status === 'Closed');
      const inputSection = document.getElementById('chatInputSection');
      const closedMsg = document.getElementById('closedMessage');
      
      if(isClosed) {
        inputSection.style.display = 'none';
        closedMsg.classList.remove('d-none');
      } else {
        inputSection.style.display = 'flex';
        closedMsg.classList.add('d-none');
      }

      // Render Chat Bubbles
      const chatWindow = document.getElementById('chatWindow');
      chatWindow.innerHTML = ''; 

      if(ticket.logs) {
        const lines = ticket.logs.split('\n');
        lines.forEach(line => {
          if(!line.trim()) return;
          
          // Check if message is from ME
          const isMe = line.includes(`[${userId}]`);
          const div = document.createElement('div');
          div.className = isMe ? 'chat-bubble chat-right' : 'chat-bubble chat-left';
          
          // Regex to extract time and message if format is "[Time] [User]: Message"
          // Fallback to displaying full line
          div.innerHTML = `<span>${line}</span>`;
          chatWindow.appendChild(div);
        });
        // Auto scroll to bottom
        setTimeout(() => { chatWindow.scrollTop = chatWindow.scrollHeight; }, 100);
      } else {
        chatWindow.innerHTML = '<div class="text-center text-muted mt-5 small">No conversation yet. Start chatting!</div>';
      }

      const modal = new bootstrap.Modal(document.getElementById('ticketDetailModal'));
      modal.show();
    }

    // --- SEND MESSAGE ---
    function sendMessage() {
      const input = document.getElementById('chatMessage');
      const message = input.value.trim();
      if(!message || !currentTicketId) return;

      // Loading state
      const btn = document.querySelector('.chat-input-area button');
      const oldHtml = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

      const payload = {
        action: 'addUpdate',
        ticketId: currentTicketId,
        userId: userId,
        message: message
      };

      fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(data => {
        if(data.success) {
          input.value = '';
          // Refresh Data and Re-render Chat locally
          fetchTickets().then(() => {
             // Find updated ticket and update chat window only
             const updatedTicket = allTickets.find(t => t.id === currentTicketId);
             if(updatedTicket) {
                const chatWindow = document.getElementById('chatWindow');
                // Creating just the last bubble would be faster, but full re-render is safer for sync
                // Let's just append the new message to look instant
                const div = document.createElement('div');
                div.className = 'chat-bubble chat-right';
                const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                div.innerHTML = `<span>[${time}] [${userId}]: ${message}</span>`;
                chatWindow.appendChild(div);
                chatWindow.scrollTop = chatWindow.scrollHeight;
             }
          });
        } else {
          alert("Failed to send message");
        }
      })
      .catch(err => console.error(err))
      .finally(() => {
        btn.disabled = false;
        btn.innerHTML = oldHtml;
      });
    }

    function handleEnter(e) {
      if(e.key === 'Enter') sendMessage();
    }

    // --- CREATE TICKET ---
    document.getElementById('createForm').addEventListener('submit', function(e){
      e.preventDefault();
      const btn = document.getElementById('submitBtn');
      const oldText = btn.innerText;
      btn.disabled = true; btn.innerText = "Submitting...";

      const payload = {
        action: 'createTicket',
        userId: userId,
        subject: document.getElementById('subject').value,
        priority: document.getElementById('priority').value,
        desc: document.getElementById('desc').value
      };

      fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) })
      .then(res => res.json())
      .then(data => {
        if(data.success) {
          bootstrap.Modal.getInstance(document.getElementById('newTicketModal')).hide();
          document.getElementById('createForm').reset();
          alert("Ticket Created!");
          fetchTickets();
        } else { alert("Error: " + data.message); }
      })
      .catch(() => alert("Server Error"))
      .finally(() => { btn.disabled = false; btn.innerText = oldText; });
    });

    function logout() {
      if(confirm("Logout?")) { sessionStorage.clear(); window.location.href = 'index.html'; }
    }
  </script>
</body>
</html>
