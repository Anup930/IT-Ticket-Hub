<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Dashboard - IT Ticket Hub</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    body {
      overflow-x: hidden;
      background-color: #f4f6f9;
    }

    /* --- Sidebar Styles --- */
    #wrapper {
      display: flex;
      width: 100%;
      height: 100vh; /* Full Height */
    }

    #sidebar-wrapper {
      min-height: 100vh;
      width: 250px;
      background-color: #212529; /* Dark Sidebar */
      color: white;
      transition: margin 0.25s ease-out;
      flex-shrink: 0;
    }

    .sidebar-heading {
      padding: 1.5rem 1.25rem;
      font-size: 1.2rem;
      font-weight: bold;
      border-bottom: 1px solid #444;
      text-align: center;
      background-color: #1c1f23;
    }

    .list-group-item {
      border: none;
      padding: 15px 20px;
      background-color: transparent;
      color: #cfd2d6;
      font-size: 1rem;
    }

    .list-group-item:hover {
      background-color: #343a40;
      color: #fff;
      cursor: pointer;
    }

    .list-group-item.active {
      background-color: #0d6efd;
      color: white;
      font-weight: bold;
      border-left: 4px solid #fff;
    }

    .list-group-item i {
      width: 25px; /* Fixed width for icons alignment */
    }

    /* --- Page Content Styles --- */
    #page-content-wrapper {
      flex: 1; /* Take remaining width */
      overflow-y: auto; /* Scrollable content */
      width: 100%;
    }

    /* Navbar inside content */
    .top-navbar {
      background-color: #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Badges */
    .badge-status-new { background-color: #3b82f6; } 
    .badge-status-resolved { background-color: #10b981; } 
    .badge-status-pending { background-color: #f59e0b; }

    /* Mobile Toggle Logic */
    #wrapper.toggled #sidebar-wrapper {
      margin-left: -250px; /* Hide Sidebar */
    }

    @media (max-width: 768px) {
      #sidebar-wrapper {
        margin-left: -250px; /* Hidden by default on mobile */
        position: fixed;
        z-index: 1000;
        height: 100%;
      }
      #wrapper.toggled #sidebar-wrapper {
        margin-left: 0; /* Show on toggle */
      }
      /* Overlay when sidebar is open on mobile */
      #overlay {
        display: none;
        position: fixed;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 900;
      }
      #wrapper.toggled #overlay {
        display: block;
      }
    }
  </style>
</head>
<body>

  <div class="d-flex" id="wrapper">
    
    <div id="overlay" onclick="toggleSidebar()"></div>

    <div id="sidebar-wrapper">
      <div class="sidebar-heading text-warning">
        <i class="fas fa-ticket-alt"></i> IT Ticket Hub
      </div>
      <div class="list-group list-group-flush mt-3">
        <a href="#" class="list-group-item list-group-item-action active">
          <i class="fas fa-tachometer-alt"></i> My Tickets
        </a>
        <a href="#" class="list-group-item list-group-item-action" data-bs-toggle="modal" data-bs-target="#newTicketModal">
          <i class="fas fa-plus-circle"></i> New Ticket
        </a>
        <a href="#" class="list-group-item list-group-item-action text-muted" style="cursor: not-allowed;" title="Coming Soon">
          <i class="fas fa-user"></i> Profile (Soon)
        </a>
        <a href="#" class="list-group-item list-group-item-action text-danger mt-4" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Logout
        </a>
      </div>
      
      <div class="mt-auto p-3 text-center text-secondary border-top border-secondary" style="font-size: 0.8rem;">
        Logged in as:<br>
        <span id="displayUserId" class="text-white">User</span>
      </div>
    </div>
    <div id="page-content-wrapper">
      
      <nav class="top-navbar">
        <button class="btn btn-outline-dark" id="menu-toggle" onclick="toggleSidebar()">
          <i class="fas fa-bars"></i>
        </button>
        <div class="fw-bold text-secondary">Dashboard</div>
      </nav>

      <div class="container-fluid p-4">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3 class="text-dark">My Support Tickets</h3>
          <button class="btn btn-success shadow-sm" data-bs-toggle="modal" data-bs-target="#newTicketModal">
            <i class="fas fa-paper-plane me-2"></i>Raise Ticket
          </button>
        </div>

        <div class="card shadow-sm border-0 rounded-3">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th class="ps-4">ID</th>
                    <th>Subject</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Date</th>
                  </tr>
                </thead>
                <tbody id="ticketBody">
                  <tr><td colspan="5" class="text-center py-5 text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Loading tickets...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div> </div> </div> <div class="modal fade" id="newTicketModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Create New Ticket</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="createForm">
            <div class="mb-3">
              <label class="form-label fw-bold">Subject</label>
              <select id="subject" class="form-select">
                <option value="Hardware Issue">Hardware Issue (Laptop/Mouse/Keyboard)</option>
                <option value="Software Issue">Software Installation/Error</option>
                <option value="Network/Internet">Internet/Network Problem</option>
                <option value="Email/Access">Email or Login Access</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">Priority</label>
              <select id="priority" class="form-select">
                <option value="Low">Low - Can wait</option>
                <option value="Medium" selected>Medium - Standard</option>
                <option value="High">High - Urgent Blockage</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">Description</label>
              <textarea id="desc" class="form-control" rows="4" placeholder="Describe your issue in detail..." required></textarea>
            </div>
            <div class="d-grid">
              <button type="submit" id="submitBtn" class="btn btn-primary btn-lg">Submit Ticket</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // *** IMPORTANT: Paste your GAS Web App URL here ***
    const API_URL = "https://script.google.com/macros/s/AKfycbwph1zPPyg0WfW2V_Jq-umvIDC3on6NlgSGpmCbz1V5fBfL3HAPClp9PL2cc-HP1xii/exec";
    
    // Check Session
    const userId = sessionStorage.getItem('userId');
    if(!userId) {
      window.location.href = 'index.html';
    }

    // Set User ID in Sidebar
    document.getElementById('displayUserId').innerText = userId;

    // Load Data on Start
    window.onload = function() {
      loadTickets();
    };

    function toggleSidebar() {
      const wrapper = document.getElementById("wrapper");
      wrapper.classList.toggle("toggled");
    }

    function loadTickets() {
      fetch(`${API_URL}?action=getTickets&userId=${userId}&role=User`)
        .then(res => res.json())
        .then(data => {
          const tbody = document.getElementById('ticketBody');
          tbody.innerHTML = '';
          
          if(!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5 text-muted">No tickets found. Create one to get started!</td></tr>';
            return;
          }

          data.forEach(t => {
            // Badges & Colors
            let badgeClass = 'bg-secondary';
            if(t.status === 'New') badgeClass = 'badge-status-new';
            if(t.status === 'Resolved' || t.status === 'Closed') badgeClass = 'badge-status-resolved';
            if(t.status === 'Pending') badgeClass = 'badge-status-pending';

            let priorityColor = t.priority === 'High' ? 'text-danger fw-bold' : 'text-dark';

            let row = `
              <tr>
                <td class="ps-4 fw-bold text-primary"><small>${t.id}</small></td>
                <td>${t.subject}</td>
                <td class="${priorityColor}">${t.priority || 'Medium'}</td>
                <td><span class="badge ${badgeClass} rounded-pill">${t.status || 'New'}</span></td>
                <td class="text-muted"><small>${t.date}</small></td>
              </tr>
            `;
            tbody.innerHTML += row;
          });
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('ticketBody').innerHTML = '<tr><td colspan="5" class="text-center text-danger py-4">Error loading data. Check API URL.</td></tr>';
        });
    }

    // Handle Form Submit
    document.getElementById('createForm').addEventListener('submit', function(e){
      e.preventDefault();
      const btn = document.getElementById('submitBtn');
      const originalText = btn.innerText;
      
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

      const payload = {
        action: 'createTicket',
        userId: userId,
        subject: document.getElementById('subject').value,
        priority: document.getElementById('priority').value,
        desc: document.getElementById('desc').value
      };

      // Using fetch with 'no-cors' mode is NOT recommended for JSON response reading
      // Standard POST request:
      fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(data => {
        if(data.success) {
          // Close Modal
          const modalEl = document.getElementById('newTicketModal');
          const modal = bootstrap.Modal.getInstance(modalEl);
          modal.hide();

          // Reset Form
          document.getElementById('createForm').reset();
          
          // Refresh Table
          loadTickets();
          
          // Show alert (Optional: replace with SweetAlert for better look)
          alert("Ticket Created Successfully!");
        } else {
          alert("Error: " + (data.message || "Unknown error"));
        }
      })
      .catch(err => {
        console.error(err);
        alert("Failed to connect to server.");
      })
      .finally(() => {
        btn.disabled = false;
        btn.innerText = originalText;
      });
    });

    function logout() {
      if(confirm("Are you sure you want to logout?")) {
        sessionStorage.clear();
        window.location.href = 'index.html';
      }
    }
  </script>
</body>
</html>
