<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root { --sidebar-width: 260px; --bg-color: #f3f4f6; --primary: #dc3545; --dark-sidebar: #111827; }
    body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); overflow-x: hidden; }
    
    #wrapper { display: flex; width: 100%; min-height: 100vh; }
    #sidebar-wrapper {
      min-height: 100vh; width: var(--sidebar-width); background-color: var(--dark-sidebar); color: #fff;
      position: fixed; left: 0; top: 0; z-index: 1000;
    }
    .list-group-item { border: none; background: transparent; color: #9ca3af; padding: 12px 25px; cursor: pointer; }
    .list-group-item:hover { color: #fff; background: rgba(255,255,255,0.05); }
    .list-group-item.active { background-color: var(--primary); color: #fff; font-weight: 600; border-left: 4px solid #fff; }
    
    #page-content-wrapper { width: 100%; margin-left: var(--sidebar-width); padding: 20px; }

    /* Cards & Tables */
    .card { border: none; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .stat-card { transition: transform 0.2s; } .stat-card:hover { transform: translateY(-3px); }
    .table thead th { background: #1f2937; color: #fff; }
    .clickable-row { cursor: pointer; } .clickable-row:hover { background-color: #f1f5f9 !important; }

    /* Chat */
    .chat-container { background: #e5ddd5; border-radius: 8px; height: 350px; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
    .chat-bubble { max-width: 80%; padding: 8px 12px; border-radius: 8px; font-size: 0.9rem; display: flex; flex-direction: column; }
    .chat-left { align-self: flex-start; background: #fff; }
    .chat-right { align-self: flex-end; background: #dcf8c6; }
    
    /* Select2 Fix */
    .select2-container { z-index: 9999; width: 100% !important; }
  </style>
</head>
<body>

<div id="wrapper">
  <div id="sidebar-wrapper">
    <div class="p-3 fs-4 fw-bold text-center border-bottom border-secondary text-danger"><i class="fas fa-shield-alt"></i> Admin Panel</div>
    <div class="list-group list-group-flush mt-3">
      <a id="menu-all" class="list-group-item active" onclick="switchTab('All')"><i class="fas fa-th-list me-2"></i> All Tickets</a>
      <a id="menu-open" class="list-group-item" onclick="switchTab('Open')"><i class="fas fa-folder-open me-2"></i> Open</a>
      <a id="menu-resolved" class="list-group-item" onclick="switchTab('Resolved')"><i class="fas fa-check-circle me-2"></i> Resolved</a>
      <a id="menu-closed" class="list-group-item" onclick="switchTab('Closed')"><i class="fas fa-archive me-2"></i> Closed</a>
      <a class="list-group-item text-danger mt-5" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> Logout</a>
    </div>
    <div class="mt-auto p-3 text-center small text-secondary">User: <span id="displayUser" class="text-white">Admin</span></div>
  </div>

  <div id="page-content-wrapper">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="fw-bold text-dark">Ticket Management</h3>
      <div>
        <button class="btn btn-primary btn-sm me-2" onclick="openCreateModal()"><i class="fas fa-plus"></i> Create Ticket</button>
        <button class="btn btn-outline-dark btn-sm" onclick="initFetch()"><i class="fas fa-sync"></i> Refresh</button>
      </div>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-md-3 col-6"><div class="card stat-card p-3 border-start border-4 border-primary"><small class="text-muted fw-bold">TOTAL</small><h3 class="fw-bold mb-0 text-primary" id="statTotal">0</h3></div></div>
      <div class="col-md-3 col-6"><div class="card stat-card p-3 border-start border-4 border-warning"><small class="text-muted fw-bold">OPEN</small><h3 class="fw-bold mb-0 text-warning" id="statOpen">0</h3></div></div>
      <div class="col-md-3 col-6"><div class="card stat-card p-3 border-start border-4 border-success"><small class="text-muted fw-bold">RESOLVED</small><h3 class="fw-bold mb-0 text-success" id="statResolved">0</h3></div></div>
      <div class="col-md-3 col-6"><div class="card stat-card p-3 border-start border-4 border-secondary"><small class="text-muted fw-bold">CLOSED</small><h3 class="fw-bold mb-0 text-secondary" id="statClosed">0</h3></div></div>
    </div>

    <div class="card p-3 mb-3 d-flex flex-row justify-content-between">
      <div class="input-group" style="max-width: 300px;">
        <span class="input-group-text bg-white"><i class="fas fa-search"></i></span>
        <input type="text" id="searchInput" class="form-control" placeholder="Search..." onkeyup="handleSearch()">
      </div>
      <select id="rowsPerPage" class="form-select w-auto" onchange="changeRows()"><option value="10">10</option><option value="20" selected>20</option><option value="50">50</option></select>
    </div>

    <div class="card shadow-sm">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead><tr><th class="ps-3">ID</th><th>User</th><th>Subject</th><th>Priority</th><th>Status</th><th>Date</th></tr></thead>
          <tbody id="adminBody"><tr><td colspan="6" class="text-center py-5">Loading...</td></tr></tbody>
        </table>
      </div>
      <div class="card-footer bg-white d-flex justify-content-between p-3">
        <small class="text-muted">Showing <span id="startRow">0</span>-<span id="endRow">0</span> of <span id="visibleTotal">0</span></small>
        <div class="btn-group"><button class="btn btn-sm btn-outline-secondary" id="prevBtn" onclick="changePage(-1)">Prev</button><button class="btn btn-sm btn-outline-secondary" id="nextBtn" onclick="changePage(1)">Next</button></div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="adminModal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white"><h5 class="modal-title">Ticket #<span id="modalId"></span></h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body bg-light">
        <div class="card border-0 shadow-sm mb-3 p-2 row text-center small"><div class="col-4">User: <strong id="modalUser" class="text-primary"></strong></div><div class="col-4">Priority: <strong id="modalPriority"></strong></div><div class="col-4">Status: <strong id="modalStatusDisplay"></strong></div></div>
        <div class="px-2 pb-2 small text-dark" id="modalDesc"></div>
        <div id="chatWindow" class="chat-container mb-0"></div>
        <div class="bg-white p-2 border d-flex gap-2">
          <select id="updateStatus" class="form-select w-auto fw-bold text-primary"><option>New</option><option>In Progress</option><option>Resolved</option><option>Closed</option></select>
          <input type="text" id="adminMsg" class="form-control" placeholder="Reply..." onkeypress="handleEnter(event)">
          <button class="btn btn-primary" id="sendBtn" onclick="sendUpdate()"><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="createModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white"><h5 class="modal-title">Create Ticket for User</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <form id="createForm">
          <div class="mb-3">
            <label class="fw-bold small">Select User</label>
            <select id="userSelect" class="form-select select2-init" style="width: 100%;" required>
              <option value="">Loading users...</option>
            </select>
          </div>
          <div class="mb-3"><label class="fw-bold small">Subject</label><select id="newSubject" class="form-select"><option>Hardware</option><option>Software</option><option>Network</option><option>Other</option></select></div>
          <div class="mb-3"><label class="fw-bold small">Priority</label><select id="newPriority" class="form-select"><option>Low</option><option selected>Medium</option><option>High</option></select></div>
          <div class="mb-3"><label class="fw-bold small">Description</label><textarea id="newDesc" class="form-control" rows="3" required></textarea></div>
          <button type="submit" id="createBtn" class="btn btn-danger w-100">Create Ticket</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwph1zPPyg0WfW2V_Jq-umvIDC3on6NlgSGpmCbz1V5fBfL3HAPClp9PL2cc-HP1xii/exec"; // UPDATE THIS
  const userId = sessionStorage.getItem('userId');
  const role = sessionStorage.getItem('role');

  if(role !== 'Admin') window.location.href = 'index.html';
  document.getElementById('displayUser').innerText = userId;

  let fullData = [], filteredData = [], currentPage = 1, rowsPerPage = 20, currentTab = 'All', currentTicketId = null;

  window.onload = () => { initFetch(); fetchUsers(); };

  function initFetch() {
    fetch(`${API_URL}?action=getAdminData&userId=${userId}`)
      .then(res => res.json())
      .then(data => { fullData = data || []; updateStats(); applyFilters(); });
  }

  // --- FETCH USER LIST FOR DROPDOWN ---
  function fetchUsers() {
    fetch(`${API_URL}?action=getUsers`)
      .then(res => res.json())
      .then(users => {
        const sel = $('#userSelect');
        sel.empty().append('<option value="">Select a User</option>');
        users.forEach(u => sel.append(new Option(u, u)));
        sel.select2({ theme: 'bootstrap-5', dropdownParent: $('#createModal') });
      });
  }

  function updateStats() {
    document.getElementById('statTotal').innerText = fullData.length;
    document.getElementById('statOpen').innerText = fullData.filter(t => t.status !== 'Resolved' && t.status !== 'Closed').length;
    document.getElementById('statResolved').innerText = fullData.filter(t => t.status === 'Resolved').length;
    document.getElementById('statClosed').innerText = fullData.filter(t => t.status === 'Closed').length;
  }

  function applyFilters() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    let temp = fullData;
    if (currentTab === 'Open') temp = temp.filter(t => t.status !== 'Resolved' && t.status !== 'Closed');
    else if (currentTab === 'Resolved') temp = temp.filter(t => t.status === 'Resolved');
    else if (currentTab === 'Closed') temp = temp.filter(t => t.status === 'Closed');

    if (search) temp = temp.filter(t => JSON.stringify(t).toLowerCase().includes(search));
    filteredData = temp; currentPage = 1; renderTable();
  }

  function renderTable() {
    const start = (currentPage - 1) * rowsPerPage, end = start + rowsPerPage, pageData = filteredData.slice(start, end);
    const tbody = document.getElementById('adminBody'); tbody.innerHTML = '';
    
    if(!pageData.length) { tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5">No tickets.</td></tr>'; return; }

    pageData.forEach(t => {
      let cls = t.status==='New'?'badge-new':(t.status==='Resolved'?'badge-resolved':(t.status==='Closed'?'badge-closed':'badge-progress'));
      tbody.innerHTML += `<tr class="clickable-row" onclick="openAdminModal('${t.id}')"><td class="ps-3 fw-bold small">${t.id}</td><td class="text-primary fw-bold small">${t.user}</td><td>${t.subject}</td><td><span class="badge ${t.priority==='High'?'bg-danger':'bg-secondary'}">${t.priority}</span></td><td><span class="badge ${cls}">${t.status}</span></td><td class="small text-muted">${t.date}</td></tr>`;
    });
    
    document.getElementById('visibleTotal').innerText = filteredData.length;
    document.getElementById('startRow').innerText = filteredData.length ? start + 1 : 0;
    document.getElementById('endRow').innerText = Math.min(end, filteredData.length);
    document.getElementById('prevBtn').disabled = currentPage === 1;
    document.getElementById('nextBtn').disabled = end >= filteredData.length;
  }

  function openAdminModal(id) {
    currentTicketId = id;
    const t = fullData.find(x => x.id === id);
    if(!t) return;
    document.getElementById('modalId').innerText = t.id;
    document.getElementById('modalUser').innerText = t.user;
    document.getElementById('modalPriority').innerText = t.priority;
    document.getElementById('modalStatusDisplay').innerText = t.status;
    document.getElementById('modalDesc').innerText = t.desc;
    document.getElementById('updateStatus').value = t.status;
    loadChat(t.logs, t.user);
    new bootstrap.Modal(document.getElementById('adminModal')).show();
  }

  function loadChat(logs, user) {
    const win = document.getElementById('chatWindow'); win.innerHTML = '';
    if(!logs) return;
    const p = /^\[(.*?)\] \[(.*?)\]: (.*)$/;
    logs.split('\n').forEach(l => {
      if(!l.trim()) return;
      const m = l.match(p); let time="", u="", msg=l; if(m){ time=m[1]; u=m[2]; msg=m[3]; }
      const isMe = u === 'Admin' || u.toLowerCase() === userId.toLowerCase();
      win.innerHTML += `<div class="chat-bubble ${isMe?'chat-right':'chat-left'}"><div style="font-size:0.6rem; font-weight:bold; color:${isMe?'#004d40':'#d63384'}">${u}</div><span>${msg}</span><div class="chat-meta">${time}</div></div>`;
    });
    setTimeout(() => win.scrollTop = win.scrollHeight, 100);
  }

  function sendUpdate() {
    const msg = document.getElementById('adminMsg').value;
    const st = document.getElementById('updateStatus').value;
    const btn = document.getElementById('sendBtn'); btn.disabled=true;
    
    fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'adminUpdate', ticketId: currentTicketId, userId, message: msg, status: st }) })
    .then(r=>r.json()).then(d => {
      if(d.success) { 
        document.getElementById('adminMsg').value=''; 
        const t = fullData.find(x => x.id === currentTicketId);
        if(t) { t.status = st; if(msg) t.logs += `\n[Now] [Admin]: ${msg}`; }
        applyFilters(); updateStats(); document.getElementById('modalStatusDisplay').innerText = st; loadChat(t.logs, t.user);
      }
    }).finally(() => btn.disabled=false);
  }

  // --- CREATE TICKET FOR USER ---
  function openCreateModal() { new bootstrap.Modal(document.getElementById('createModal')).show(); }

  document.getElementById('createForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const selUser = $('#userSelect').val();
    if(!selUser) { alert("Please select a user"); return; }
    
    const btn = document.getElementById('createBtn'); btn.disabled=true; btn.innerText="Creating...";
    
    const payload = {
      action: 'createTicket',
      userId: selUser, // Ticket Owner
      creatorId: userId, // Creator (Admin)
      subject: document.getElementById('newSubject').value,
      priority: document.getElementById('newPriority').value,
      desc: document.getElementById('newDesc').value
    };

    fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) })
    .then(r=>r.json()).then(d => {
      if(d.success) {
        bootstrap.Modal.getInstance(document.getElementById('createModal')).hide();
        document.getElementById('createForm').reset();
        $('#userSelect').val(null).trigger('change');
        alert("Ticket Created Successfully!");
        initFetch();
      } else alert(d.message);
    }).finally(() => { btn.disabled=false; btn.innerText="Create Ticket"; });
  });

  function handleSearch() { applyFilters(); }
  function changeRows() { rowsPerPage = parseInt(document.getElementById('rowsPerPage').value); applyFilters(); }
  function changePage(d) { currentPage += d; renderTable(); }
  function switchTab(t) { currentTab=t; document.querySelectorAll('.list-group-item').forEach(el=>el.classList.remove('active')); event.currentTarget.classList.add('active'); applyFilters(); }
  function handleEnter(e) { if(e.key === 'Enter') sendUpdate(); }
  function logout() { sessionStorage.clear(); window.location.href = 'index.html'; }
</script>
</body>
</html>
