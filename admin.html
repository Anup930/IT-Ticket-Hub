<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root { --sidebar-width: 260px; --bg-color: #f8f9fa; --primary: #dc3545; --dark-sidebar: #1e293b; }
    body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); overflow-x: hidden; }
    
    /* Layout */
    #wrapper { display: flex; width: 100%; min-height: 100vh; }
    #sidebar-wrapper {
      min-height: 100vh; width: var(--sidebar-width); background-color: var(--dark-sidebar); color: #fff;
      position: fixed; left: 0; top: 0; z-index: 1000;
    }
    
    .list-group-item { border: none; background: transparent; color: #94a3b8; padding: 12px 25px; cursor: pointer; transition: 0.2s; }
    .list-group-item:hover { color: #fff; background: rgba(255,255,255,0.1); }
    .list-group-item.active { background-color: var(--primary); color: #fff; font-weight: 600; border-left: 4px solid #fff; }
    
    #page-content-wrapper { width: 100%; margin-left: var(--sidebar-width); padding: 20px; }

    /* Cards */
    .card { border: none; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); background: white; }
    .stat-card { transition: transform 0.2s; } 
    .stat-card:hover { transform: translateY(-3px); }

    /* Table Styling */
    .table thead th { background: #334155; color: #fff; border: none; padding: 12px; font-weight: 500; font-size: 0.9rem; }
    .clickable-row { cursor: pointer; transition: 0.2s; }
    .clickable-row:hover { background-color: #f1f5f9 !important; }
    .table td { vertical-align: middle; padding: 12px; font-size: 0.9rem; }

    /* Custom Badges */
    .badge-custom { padding: 6px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 600; }
    .status-new { background-color: #e0f2fe; color: #0369a1; }       /* Light Blue */
    .status-progress { background-color: #fef9c3; color: #854d0e; }  /* Yellow */
    .status-resolved { background-color: #dcfce7; color: #15803d; }  /* Green */
    .status-closed { background-color: #f1f5f9; color: #475569; }    /* Gray */
    .status-pending { background-color: #ffedd5; color: #9a3412; }   /* Orange */

    /* Priority Badges */
    .prio-high { color: #dc2626; font-weight: bold; background: #fee2e2; padding: 4px 8px; border-radius: 4px; }
    .prio-medium { color: #d97706; font-weight: bold; background: #fef3c7; padding: 4px 8px; border-radius: 4px; }
    .prio-low { color: #059669; font-weight: bold; background: #d1fae5; padding: 4px 8px; border-radius: 4px; }

    /* Chat Styling */
    .chat-container { background: #e2e8f0; border-radius: 8px; height: 350px; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
    .chat-bubble { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 0.9rem; display: flex; flex-direction: column; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .chat-left { align-self: flex-start; background: #fff; border-bottom-left-radius: 2px; }
    .chat-right { align-self: flex-end; background: #3b82f6; color: white; border-bottom-right-radius: 2px; }
    
    /* Select2 */
    .select2-container { z-index: 9999; width: 100% !important; }
  </style>
</head>
<body>

<div id="wrapper">
  
  <div id="sidebar-wrapper">
    <div class="p-4 fs-4 fw-bold text-center border-bottom border-secondary text-danger">
      <i class="fas fa-user-shield me-2"></i> Admin Panel
    </div>
    <div class="list-group list-group-flush mt-3">
      <a id="menu-all" class="list-group-item active" onclick="switchTab('All')">
        <i class="fas fa-list me-3"></i> All Tickets
      </a>
      <a id="menu-open" class="list-group-item" onclick="switchTab('Open')">
        <i class="fas fa-folder-open me-3"></i> Open Tickets
      </a>
      <a id="menu-resolved" class="list-group-item" onclick="switchTab('Resolved')">
        <i class="fas fa-check-circle me-3"></i> Resolved
      </a>
      <a id="menu-closed" class="list-group-item" onclick="switchTab('Closed')">
        <i class="fas fa-archive me-3"></i> Closed
      </a>
      <a class="list-group-item text-danger mt-5" onclick="logout()">
        <i class="fas fa-sign-out-alt me-3"></i> Logout
      </a>
    </div>
    <div class="mt-auto p-3 text-center small text-secondary">User: <span id="displayUser" class="text-white">Admin</span></div>
  </div>

  <div id="page-content-wrapper">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 class="fw-bold text-dark">Ticket Management</h3>
      <div>
        <button class="btn btn-danger text-white btn-sm me-2 shadow-sm" onclick="openCreateModal()"><i class="fas fa-plus"></i> Create Ticket</button>
        <button class="btn btn-outline-dark btn-sm shadow-sm" onclick="initFetch()"><i class="fas fa-sync"></i> Refresh</button>
      </div>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-md-3 col-6"><div class="card stat-card p-3 border-start border-4 border-primary"><small class="text-muted fw-bold">TOTAL</small><h3 class="fw-bold mb-0 text-primary" id="statTotal">0</h3></div></div>
      <div class="col-md-3 col-6"><div class="card stat-card p-3 border-start border-4 border-warning"><small class="text-muted fw-bold">OPEN</small><h3 class="fw-bold mb-0 text-warning" id="statOpen">0</h3></div></div>
      <div class="col-md-3 col-6"><div class="card stat-card p-3 border-start border-4 border-success"><small class="text-muted fw-bold">RESOLVED</small><h3 class="fw-bold mb-0 text-success" id="statResolved">0</h3></div></div>
      <div class="col-md-3 col-6"><div class="card stat-card p-3 border-start border-4 border-secondary"><small class="text-muted fw-bold">CLOSED</small><h3 class="fw-bold mb-0 text-secondary" id="statClosed">0</h3></div></div>
    </div>

    <div class="card p-3 mb-3">
      <div class="row g-3 align-items-center">
        <div class="col-md-6">
          <div class="input-group">
            <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
            <input type="text" id="searchInput" class="form-control border-start-0" placeholder="Search ID, Name, Email, Status, Priority..." onkeyup="handleSearch()">
          </div>
        </div>
        <div class="col-md-6 text-md-end">
          <label class="small fw-bold me-2">Show:</label>
          <select id="rowsPerPage" class="form-select d-inline-block w-auto form-select-sm" onchange="changeRows()">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="200">200</option>
            <option value="99999">All</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card shadow-sm overflow-hidden">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th class="ps-4">Ticket ID</th>
              <th>User / Employee</th>
              <th>Subject</th>
              <th>Priority</th>
              <th>Status</th>
              <th>Date</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="adminBody">
            <tr><td colspan="7" class="text-center py-5 text-muted"><i class="fas fa-spinner fa-spin"></i> Loading Tickets...</td></tr>
          </tbody>
        </table>
      </div>
      
      <div class="card-footer bg-white d-flex justify-content-between align-items-center p-3">
        <small class="text-muted">Showing <span id="startRow">0</span> to <span id="endRow">0</span> of <span id="visibleTotal">0</span> entries</small>
        <div class="btn-group">
          <button class="btn btn-sm btn-outline-secondary" id="prevBtn" onclick="changePage(-1)">Previous</button>
          <button class="btn btn-sm btn-outline-secondary" id="nextBtn" onclick="changePage(1)">Next</button>
        </div>
      </div>
    </div>

  </div>
</div>

<div class="modal fade" id="adminModal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title">Ticket #<span id="modalId"></span></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body bg-light">
        <div class="card border-0 shadow-sm mb-3 p-3">
          <div class="row text-center">
            <div class="col-4 border-end">User<br><strong class="text-primary" id="modalUser"></strong></div>
            <div class="col-4 border-end">Priority<br><span id="modalPriority"></span></div>
            <div class="col-4">Status<br><span id="modalStatusDisplay"></span></div>
          </div>
          <div class="mt-3 pt-3 border-top">
            <small class="text-muted fw-bold">DESCRIPTION:</small>
            <p class="small text-dark mb-0" id="modalDesc"></p>
          </div>
        </div>

        <h6 class="fw-bold text-secondary px-1">Discussion</h6>
        <div id="chatWindow" class="chat-container mb-0" style="border-bottom-left-radius: 0; border-bottom-right-radius: 0;"></div>

        <div class="bg-white p-2 border border-top-0 rounded-bottom d-flex gap-2 align-items-center">
          <select id="updateStatus" class="form-select w-auto fw-bold text-primary border-primary">
            <option value="New">New</option>
            <option value="In Progress">In Progress</option>
            <option value="Pending">Pending</option>
            <option value="Resolved">Resolved</option>
            <option value="Closed">Closed</option>
          </select>
          <input type="text" id="adminMsg" class="form-control" placeholder="Type reply here..." onkeypress="handleEnter(event)">
          <button class="btn btn-primary px-3" id="sendBtn" onclick="sendUpdate()"><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="createModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white"><h5 class="modal-title">Create Ticket for User</h5><button class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <form id="createForm">
          <div class="mb-3">
            <label class="fw-bold small">Select User</label>
            <select id="userSelect" class="form-select select2-init" style="width: 100%;" required><option value="">Loading...</option></select>
          </div>
          <div class="mb-3"><label class="fw-bold small">Subject</label><select id="newSubject" class="form-select"><option>Hardware</option><option>Software</option><option>Network</option><option>Other</option></select></div>
          <div class="mb-3"><label class="fw-bold small">Priority</label><select id="newPriority" class="form-select"><option>Low</option><option selected>Medium</option><option>High</option></select></div>
          <div class="mb-3"><label class="fw-bold small">Description</label><textarea id="newDesc" class="form-control" rows="3" required></textarea></div>
          <button type="submit" id="createBtn" class="btn btn-danger w-100">Create Ticket</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  // *** API URL ***
  const API_URL = "https://script.google.com/macros/s/AKfycbwph1zPPyg0WfW2V_Jq-umvIDC3on6NlgSGpmCbz1V5fBfL3HAPClp9PL2cc-HP1xii/exec"; // REPLACE THIS!

  const userId = sessionStorage.getItem('userId');
  const role = sessionStorage.getItem('role');

  if(role !== 'Admin') window.location.href = 'index.html';
  document.getElementById('displayUser').innerText = userId;

  let fullData = [], filteredData = [], currentPage = 1, rowsPerPage = 20, currentTab = 'All', currentTicketId = null;

  window.onload = () => { initFetch(); fetchUsers(); };

  function initFetch() {
    fetch(`${API_URL}?action=getAdminData&userId=${userId}`)
      .then(res => res.json())
      .then(data => { 
        fullData = data || []; 
        updateStats(); 
        applyFilters(); 
      });
  }

  function fetchUsers() {
    fetch(`${API_URL}?action=getUsers`)
      .then(res => res.json())
      .then(users => {
        const sel = $('#userSelect'); sel.empty().append('<option value="">Select a User</option>');
        users.forEach(u => sel.append(new Option(u, u)));
        sel.select2({ theme: 'bootstrap-5', dropdownParent: $('#createModal') });
      });
  }

  function updateStats() {
    document.getElementById('statTotal').innerText = fullData.length;
    document.getElementById('statOpen').innerText = fullData.filter(t => t.status !== 'Resolved' && t.status !== 'Closed').length;
    document.getElementById('statResolved').innerText = fullData.filter(t => t.status === 'Resolved').length;
    document.getElementById('statClosed').innerText = fullData.filter(t => t.status === 'Closed').length;
  }

  // --- IMPROVED FILTER & SEARCH ---
  function applyFilters() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    
    // 1. Filter by Tab
    let temp = fullData;
    if (currentTab === 'Open') temp = fullData.filter(t => t.status !== 'Resolved' && t.status !== 'Closed');
    else if (currentTab === 'Resolved') temp = fullData.filter(t => t.status === 'Resolved');
    else if (currentTab === 'Closed') temp = fullData.filter(t => t.status === 'Closed');

    // 2. Filter by Search (Checks ID, User, Subject, Priority, Status, Date)
    if (search) {
      temp = temp.filter(t => 
        (t.id && t.id.toLowerCase().includes(search)) ||
        (t.user && t.user.toLowerCase().includes(search)) ||
        (t.subject && t.subject.toLowerCase().includes(search)) ||
        (t.priority && t.priority.toLowerCase().includes(search)) ||
        (t.status && t.status.toLowerCase().includes(search)) ||
        (t.date && t.date.toLowerCase().includes(search))
      );
    }

    filteredData = temp; 
    currentPage = 1; 
    renderTable();
  }

  function renderTable() {
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const pageData = filteredData.slice(start, end);
    const tbody = document.getElementById('adminBody'); 
    tbody.innerHTML = '';
    
    if(!pageData.length) { tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-muted">No tickets found.</td></tr>'; return; }

    pageData.forEach(t => {
      // Fix Status Colors
      let badgeHtml = getStatusBadge(t.status);
      let prioClass = t.priority === 'High' ? 'prio-high' : (t.priority === 'Low' ? 'prio-low' : 'prio-medium');

      tbody.innerHTML += `
        <tr class="clickable-row" onclick="openAdminModal('${t.id}')">
          <td class="ps-4 fw-bold small text-dark">${t.id}</td>
          <td class="text-primary fw-bold small">${t.user}</td>
          <td>${t.subject}</td>
          <td><span class="${prioClass}">${t.priority}</span></td>
          <td>${badgeHtml}</td>
          <td class="small text-muted">${t.date}</td>
          <td><button class="btn btn-sm btn-outline-dark py-0 px-2">Edit</button></td>
        </tr>`;
    });
    
    // Update Pagination Info
    document.getElementById('visibleTotal').innerText = filteredData.length;
    document.getElementById('startRow').innerText = filteredData.length ? start + 1 : 0;
    document.getElementById('endRow').innerText = Math.min(end, filteredData.length);
    document.getElementById('prevBtn').disabled = currentPage === 1;
    document.getElementById('nextBtn').disabled = end >= filteredData.length;
  }

  // --- HELPER: STATUS BADGE LOGIC ---
  function getStatusBadge(status) {
    if (!status) return '<span class="badge badge-custom status-closed">Unknown</span>';
    let s = status.toLowerCase();
    if (s.includes('new')) return `<span class="badge badge-custom status-new">${status}</span>`;
    if (s.includes('progress')) return `<span class="badge badge-custom status-progress">${status}</span>`;
    if (s.includes('resolved')) return `<span class="badge badge-custom status-resolved">${status}</span>`;
    if (s.includes('pending')) return `<span class="badge badge-custom status-pending">${status}</span>`;
    return `<span class="badge badge-custom status-closed">${status}</span>`;
  }

  // --- ADMIN MODAL & CHAT ---
  function openAdminModal(id) {
    currentTicketId = id;
    const t = fullData.find(x => x.id === id);
    if(!t) return;

    document.getElementById('modalId').innerText = t.id;
    document.getElementById('modalUser').innerText = t.user;
    document.getElementById('modalPriority').innerHTML = `<span class="${t.priority==='High'?'text-danger':''}">${t.priority}</span>`;
    document.getElementById('modalStatusDisplay').innerHTML = getStatusBadge(t.status);
    document.getElementById('modalDesc').innerText = t.desc;
    document.getElementById('updateStatus').value = t.status;

    loadChat(t.logs, t.user);
    new bootstrap.Modal(document.getElementById('adminModal')).show();
  }

  function loadChat(logs, user) {
    const win = document.getElementById('chatWindow'); win.innerHTML = '';
    if(!logs) { win.innerHTML = '<div class="text-center mt-5 small text-muted">No logs.</div>'; return; }

    const pattern = /^\[(.*?)\] \[(.*?)\]: (.*)$/;
    logs.split('\n').forEach(line => {
      if(!line.trim()) return;
      const m = line.match(pattern);
      let time="", u="", msg=line;
      if(m) { time=m[1]; u=m[2]; msg=m[3]; }

      // Admin (Right), User (Left)
      const isMe = u === 'Admin' || u.toLowerCase() === userId.toLowerCase();
      
      win.innerHTML += `
        <div class="chat-bubble ${isMe?'chat-right':'chat-left'}">
          <div style="font-size:0.6rem; font-weight:bold; color:${isMe?'#e0e0e0':'#2563eb'}">${u}</div>
          <span>${msg}</span><div class="text-end" style="font-size:0.6rem; opacity:0.7;">${time}</div>
        </div>`;
    });
    setTimeout(() => win.scrollTop = win.scrollHeight, 100);
  }

  function sendUpdate() {
    const msg = document.getElementById('adminMsg').value;
    const st = document.getElementById('updateStatus').value;
    const btn = document.getElementById('sendBtn'); btn.disabled=true;
    
    fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'adminUpdate', ticketId: currentTicketId, userId: userId, message: msg, status: st }) })
    .then(r=>r.json()).then(d => {
      if(d.success) { 
        document.getElementById('adminMsg').value=''; 
        const t = fullData.find(x => x.id === currentTicketId);
        if(t) { t.status = st; if(msg) t.logs += `\n[Now] [Admin]: ${msg}`; }
        
        applyFilters(); updateStats(); 
        document.getElementById('modalStatusDisplay').innerHTML = getStatusBadge(st); 
        loadChat(t.logs, t.user);
      }
    }).finally(() => btn.disabled=false);
  }

  function handleEnter(e) { if(e.key === 'Enter') sendUpdate(); }
  function handleSearch() { applyFilters(); }
  function changeRows() { rowsPerPage = parseInt(document.getElementById('rowsPerPage').value); applyFilters(); }
  function changePage(d) { currentPage += d; renderTable(); }
  
  function switchTab(t) { 
    currentTab=t; 
    document.querySelectorAll('.list-group-item').forEach(el=>el.classList.remove('active')); 
    if(t==='All') document.getElementById('menu-all').classList.add('active');
    else if(t==='Open') document.getElementById('menu-open').classList.add('active');
    else if(t==='Resolved') document.getElementById('menu-resolved').classList.add('active');
    else document.getElementById('menu-closed').classList.add('active');
    applyFilters(); 
  }

  // Create Ticket
  function openCreateModal() { new bootstrap.Modal(document.getElementById('createModal')).show(); }
  document.getElementById('createForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const selUser = $('#userSelect').val();
    if(!selUser) { alert("Select a user"); return; }
    const btn = document.getElementById('createBtn'); btn.disabled=true; btn.innerText="Creating...";
    fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'createTicket', userId: selUser, creatorId: userId, subject: document.getElementById('newSubject').value, priority: document.getElementById('newPriority').value, desc: document.getElementById('newDesc').value }) })
    .then(r=>r.json()).then(d => {
      if(d.success) { bootstrap.Modal.getInstance(document.getElementById('createModal')).hide(); document.getElementById('createForm').reset(); $('#userSelect').val(null).trigger('change'); alert("Created!"); initFetch(); } 
      else alert(d.message);
    }).finally(() => { btn.disabled=false; btn.innerText="Create Ticket"; });
  });

  function logout() { sessionStorage.clear(); window.location.href = 'index.html'; }
</script>
</body>
</html>
