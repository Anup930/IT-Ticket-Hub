<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* Styling (Same High Quality look) */
    :root { --sidebar-width: 260px; --bg-color: #f3f4f6; }
    body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); overflow-x: hidden; }
    
    #wrapper { display: flex; width: 100%; min-height: 100vh; }
    #sidebar-wrapper {
      min-height: 100vh; width: var(--sidebar-width); background-color: #111827; color: #fff;
      position: fixed; left: 0; top: 0; z-index: 1000;
    }
    .list-group-item { border: none; background: transparent; color: #9ca3af; padding: 15px 20px; cursor: pointer; }
    .list-group-item:hover, .list-group-item.active { background-color: #dc3545; color: #fff; }
    
    #page-content-wrapper { width: 100%; margin-left: var(--sidebar-width); padding: 20px; }
    
    /* Table & Modal */
    .card { border: none; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .table thead th { background: #1f2937; color: #fff; }
    
    /* Chat */
    .chat-container { background: #e5ddd5; border-radius: 8px; height: 350px; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
    .chat-bubble { max-width: 80%; padding: 8px 12px; border-radius: 8px; font-size: 0.9rem; position: relative; display: flex; flex-direction: column; }
    .chat-left { align-self: flex-start; background: #fff; } /* User Msg */
    .chat-right { align-self: flex-end; background: #dcf8c6; } /* Admin Msg */
    .chat-meta { font-size: 0.7rem; margin-top: 4px; text-align: right; opacity: 0.7; }
  </style>
</head>
<body>

<div id="wrapper">
  <div id="sidebar-wrapper">
    <div class="p-3 fs-4 fw-bold text-center border-bottom border-secondary text-danger">
      <i class="fas fa-shield-alt"></i> Admin Panel
    </div>
    <div class="list-group list-group-flush mt-3">
      <a class="list-group-item active"><i class="fas fa-ticket-alt me-2"></i> Ticket Management</a>
      <a class="list-group-item text-danger mt-5" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> Logout</a>
    </div>
    <div class="mt-auto p-3 text-center small text-secondary">Admin: <span id="displayUser" class="text-white"></span></div>
  </div>

  <div id="page-content-wrapper">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3 class="fw-bold">All Active Tickets</h3>
      <button class="btn btn-outline-dark btn-sm" onclick="fetchAdminData()"><i class="fas fa-sync"></i> Refresh</button>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card p-3 border-start border-4 border-primary">
          <small class="text-muted fw-bold">TOTAL TICKETS</small>
          <h3 class="fw-bold mb-0" id="statTotal">0</h3>
        </div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead><tr><th class="ps-3">ID</th><th>User</th><th>Subject</th><th>Priority</th><th>Status</th><th>Date</th></tr></thead>
          <tbody id="adminBody"><tr><td colspan="6" class="text-center py-5">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="adminModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title">Manage Ticket #<span id="modalId"></span></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body bg-light">
        <div class="card border-0 shadow-sm mb-3">
          <div class="card-body p-2 row text-center small">
            <div class="col-4 border-end">User: <strong class="text-primary" id="modalUser"></strong></div>
            <div class="col-4 border-end">Priority: <strong id="modalPriority"></strong></div>
            <div class="col-4">Status: <strong id="modalStatusDisplay"></strong></div>
          </div>
          <div class="px-3 pb-2 small text-dark border-top pt-2" id="modalDesc"></div>
        </div>

        <div id="chatWindow" class="chat-container mb-0" style="border-bottom-left-radius: 0; border-bottom-right-radius: 0;"></div>

        <div class="bg-white p-2 border border-top-0 rounded-bottom d-flex gap-2">
          <select id="updateStatus" class="form-select w-auto fw-bold text-primary">
            <option value="New">New</option>
            <option value="In Progress">In Progress</option>
            <option value="Resolved">Resolved</option>
            <option value="Closed">Closed</option>
          </select>
          <input type="text" id="adminMsg" class="form-control" placeholder="Reply..." onkeypress="handleEnter(event)">
          <button class="btn btn-primary" id="sendBtn" onclick="sendUpdate()"><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwph1zPPyg0WfW2V_Jq-umvIDC3on6NlgSGpmCbz1V5fBfL3HAPClp9PL2cc-HP1xii/exec"; // REPLACE THIS!
  const userId = sessionStorage.getItem('userId');
  const role = sessionStorage.getItem('role');

  if(role !== 'Admin') window.location.href = 'index.html';
  document.getElementById('displayUser').innerText = userId;

  let allTickets = [], currentId = null;

  window.onload = () => fetchAdminData();

  function fetchAdminData() {
    // Calling NEW Admin Function
    fetch(`${API_URL}?action=getAdminData&userId=${userId}`)
      .then(res => res.json())
      .then(data => {
        allTickets = data || [];
        document.getElementById('statTotal').innerText = allTickets.length;
        renderTable();
      });
  }

  function renderTable() {
    const tbody = document.getElementById('adminBody'); tbody.innerHTML = '';
    if(!allTickets.length) { tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5">No tickets.</td></tr>'; return; }

    allTickets.forEach(t => {
      let cls = t.status==='New'?'bg-primary':(t.status==='Resolved'?'bg-success':'bg-secondary');
      tbody.innerHTML += `
        <tr style="cursor:pointer" onclick="openAdminModal('${t.id}')">
          <td class="ps-3 fw-bold small">${t.id}</td>
          <td class="text-primary fw-bold small">${t.user}</td>
          <td>${t.subject}</td>
          <td><span class="badge ${t.priority==='High'?'bg-danger':'bg-dark'}">${t.priority}</span></td>
          <td><span class="badge ${cls}">${t.status}</span></td>
          <td class="text-muted small">${t.date}</td>
        </tr>`;
    });
  }

  function openAdminModal(id) {
    currentId = id;
    const t = allTickets.find(x => x.id === id);
    if(!t) return;

    document.getElementById('modalId').innerText = t.id;
    document.getElementById('modalUser').innerText = t.user;
    document.getElementById('modalPriority').innerText = t.priority;
    document.getElementById('modalStatusDisplay').innerText = t.status;
    document.getElementById('modalDesc').innerText = t.desc;
    document.getElementById('updateStatus').value = t.status;

    loadChat(t.logs);
    new bootstrap.Modal(document.getElementById('adminModal')).show();
  }

  function loadChat(logs) {
    const win = document.getElementById('chatWindow'); win.innerHTML = '';
    if(!logs) { win.innerHTML = '<div class="text-center mt-5 small text-muted">No logs.</div>'; return; }

    // Parse [Time] [User]: Msg
    const pattern = /^\[(.*?)\] \[(.*?)\]: (.*)$/;
    logs.split('\n').forEach(line => {
      if(!line.trim()) return;
      const m = line.match(pattern);
      let time="", user="", msg=line;
      if(m) { time=m[1]; user=m[2]; msg=m[3]; }

      // Logic: Admin (Me) -> Right, User -> Left
      // Assuming Admin ID in session matches what's logged
      // If logged user is NOT me (Admin), then it's the User (Left)
      // If logged user IS me (Admin), then it's Me (Right)
      const isMe = user.toLowerCase() === userId.toLowerCase() || user === 'Admin';
      
      win.innerHTML += `
        <div class="chat-bubble ${isMe?'chat-right':'chat-left'}">
          <div style="font-size:0.65rem; font-weight:bold; color:${isMe?'#004d40':'#d63384'}">${user}</div>
          <span>${msg}</span><div class="chat-meta">${time}</div>
        </div>`;
    });
    setTimeout(() => win.scrollTop = win.scrollHeight, 100);
  }

  function sendUpdate() {
    const msg = document.getElementById('adminMsg').value;
    const status = document.getElementById('updateStatus').value;
    const btn = document.getElementById('sendBtn');

    // If message empty, send status update only
    if(!msg && status === document.getElementById('modalStatusDisplay').innerText) return;

    btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    // Calling NEW Admin Update Function
    fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'adminUpdate',
        ticketId: currentId,
        userId: userId, // Admin Name
        message: msg,
        status: status
      })
    })
    .then(res => res.json())
    .then(data => {
      if(data.success) {
        document.getElementById('adminMsg').value = '';
        fetchAdminData().then(() => {
           // Find updated ticket to refresh modal
           const t = allTickets.find(x => x.id === currentId);
           if(t) {
             document.getElementById('modalStatusDisplay').innerText = t.status;
             loadChat(t.logs);
           }
        });
      } else alert("Error");
    })
    .finally(() => { btn.disabled = false; btn.innerHTML = '<i class="fas fa-paper-plane"></i>'; });
  }

  function handleEnter(e) { if(e.key === 'Enter') sendUpdate(); }
  function logout() { sessionStorage.clear(); window.location.href = 'index.html'; }
</script>
</body>
</html>
