<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Management - IT Ticket Hub</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root { --primary: #4f46e5; --bg-body: #f3f4f6; --sidebar-bg: #0f172a; --sidebar-width: 280px; }
    body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); overflow-x: hidden; }
    #wrapper { display: flex; width: 100%; min-height: 100vh; }
    #sidebar-wrapper { width: var(--sidebar-width); background-color: var(--sidebar-bg); color: #94a3b8; position: fixed; left: 0; top: 0; bottom: 0; display: flex; flex-direction: column; z-index: 1000; }
    .sidebar-brand { padding: 2rem 1.5rem; color: #fff; font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .list-group-item { background: transparent; border: none; color: #94a3b8; padding: 14px 24px; font-weight: 500; cursor: pointer; text-decoration: none; display: block;}
    .list-group-item:hover { color: #fff; background: rgba(255,255,255,0.05); }
    .list-group-item.active { background: linear-gradient(90deg, rgba(79, 70, 229, 0.15) 0%, transparent 100%); color: #818cf8; border-left: 3px solid #818cf8; }
    #page-content-wrapper { width: 100%; margin-left: var(--sidebar-width); padding: 30px; }
    .content-card { background: white; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: none; padding: 24px; }
    .table thead th { background: #f8fafc; color: #64748b; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; border: none; padding: 16px; }
    .table tbody td { padding: 16px; vertical-align: middle; color: #334155; font-size: 0.9rem; border-bottom: 1px solid #f1f5f9; }
    .badge-status { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
    .bg-active { background: #dcfce7; color: #166534; }
    .bg-inactive { background: #fee2e2; color: #991b1b; }
    .clickable-row { cursor: pointer; transition: background 0.1s; }
    .clickable-row:hover { background-color: #f8fafc !important; }
  </style>
</head>
<body>

<div id="wrapper">

  <div id="sidebar-wrapper">
    <div class="sidebar-brand"><i class="fa-solid fa-layer-group"></i> IT Ticket Hub</div>
    <div class="list-group list-group-flush mt-3 px-3 gap-1">
      <a href="dashboard.html" class="list-group-item rounded"><i class="fas fa-chart-pie me-3"></i> Analytics</a>
      <a href="admin.html" class="list-group-item rounded"><i class="fas fa-list me-3"></i> All Tickets</a>
      <a href="users.html" class="list-group-item active rounded"><i class="fas fa-users me-3"></i> Manage Users</a>
      <a href="notification.html" class="list-group-item rounded"><i class="fas fa-bell me-3"></i> Notifications</a>
    </div>
    <div class="mt-auto p-3 mb-3">
        <button onclick="logout()" class="btn btn-danger w-100 btn-sm"><i class="fas fa-sign-out-alt me-2"></i> Log Out</button>
    </div>
  </div>

  <div id="page-content-wrapper">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h3 class="fw-bold mb-1">User Management</h3>
        <p class="text-muted small mb-0">Manage system access & security</p>
      </div>
      <button class="btn btn-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#addUserModal">
        <i class="fas fa-user-plus me-2"></i> Add New User
      </button>
    </div>

    <div class="content-card">
      <div class="d-flex justify-content-between mb-3">
        <input type="text" id="searchUser" class="form-control w-25" placeholder="Search by Name or EMP ID..." onkeyup="handleSearch()">
        <button class="btn btn-light border" onclick="fetchUsers()"><i class="fas fa-sync-alt"></i></button>
      </div>

      <div class="table-responsive">
        <table class="table mb-0">
          <thead>
            <tr>
              <th class="ps-4">User Name / ID</th>
              <th>EMP ID</th>
              <th>Contact</th>
              <th>Role</th>
              <th>Status</th>
              <th class="text-end pe-4">Actions</th>
            </tr>
          </thead>
          <tbody id="userTableBody">
            <tr><td colspan="6" class="text-center py-5 text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Loading Users...</td></tr>
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
        <div class="d-flex align-items-center gap-2">
            <small class="text-muted fw-bold">Rows per page:</small>
            <select id="rowsPerPage" class="form-select form-select-sm border-secondary text-center" style="width: 70px;" onchange="changeRowsPerPage()">
                <option value="10">10</option>
                <option value="20" selected>20</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="200">200</option>
            </select>
        </div>
        
        <div class="d-flex align-items-center gap-3">
            <small class="text-muted">Showing <span id="startRow" class="fw-bold text-dark">0</span> - <span id="endRow" class="fw-bold text-dark">0</span> of <span id="totalRows" class="fw-bold text-dark">0</span></small>
            <div class="btn-group">
                <button class="btn btn-sm btn-outline-secondary" id="btnPrev" onclick="changePage(-1)"><i class="fas fa-chevron-left"></i></button>
                <button class="btn btn-sm btn-outline-secondary" id="btnNext" onclick="changePage(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
      </div>

    </div>

  </div>
</div>

<div class="modal fade" id="addUserModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Add New User</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addUserForm">
          <div class="row g-2 mb-3">
            <div class="col-md-6">
              <label class="small fw-bold text-muted">User Name</label>
              <input type="text" id="newUserName" class="form-control" required placeholder="e.g. Rahul Singh">
            </div>
            <div class="col-md-6">
              <label class="small fw-bold text-muted">EMP ID</label>
              <input type="text" id="newEmpId" class="form-control" placeholder="e.g. G101">
            </div>
          </div>
          <div class="mb-3">
            <label class="small fw-bold text-muted">Email Address</label>
            <input type="email" id="newUserEmail" class="form-control" required placeholder="rahul@company.com">
          </div>
          <div class="row g-2 mb-3">
            <div class="col-md-6">
              <label class="small fw-bold text-muted">Phone Number</label>
              <input type="text" id="newUserPhone" class="form-control" placeholder="9876543210">
            </div>
            <div class="col-md-6">
              <label class="small fw-bold text-muted">Role</label>
              <select id="newUserRole" class="form-select">
                <option value="User">User</option>
                <option value="Admin">Admin</option>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label class="small fw-bold text-muted">Password</label>
            <input type="text" id="newUserPass" class="form-control" required value="Gretex@123">
          </div>
          <button type="submit" id="addBtn" class="btn btn-primary w-100">Create User</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="editUserModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header border-0 bg-light">
        <div>
          <h5 class="modal-title fw-bold" id="editUserName">User Name</h5>
          <small class="text-muted" id="editUserId">User ID</small>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3 mb-4">
            <div class="col-6">
                <label class="small text-muted fw-bold">Email</label>
                <div class="text-dark" id="editUserEmail">-</div>
            </div>
            <div class="col-6">
                <label class="small text-muted fw-bold">EMP ID</label>
                <div class="text-dark" id="editEmpId">-</div>
            </div>
            <div class="col-6">
                <label class="small text-muted fw-bold">Phone</label>
                <div class="text-dark" id="editUserPhone">-</div>
            </div>
            <div class="col-6">
                <label class="small text-muted fw-bold">Role</label>
                <div><span class="badge bg-secondary" id="editUserRole">-</span></div>
            </div>
        </div>
        
        <hr class="text-muted">
        
        <h6 class="fw-bold text-danger mb-3"><i class="fas fa-lock me-2"></i>Security Settings</h6>
        
        <div id="resetSection">
            <button class="btn btn-outline-danger w-100" onclick="showResetInput()">
                Reset Password
            </button>
        </div>

        <div id="resetInputDiv" class="d-none bg-light p-3 rounded border">
            <label class="small fw-bold text-muted mb-1">Enter New Password</label>
            <div class="input-group mb-2">
                <input type="text" id="newResetPass" class="form-control" placeholder="New Password">
                <button class="btn btn-danger" id="savePassBtn" onclick="confirmResetPassword()">Save</button>
            </div>
            <small class="text-muted d-block">User will need to login with this new password.</small>
            <a href="#" class="text-decoration-none small text-secondary mt-2 d-inline-block" onclick="hideResetInput()">Cancel</a>
        </div>

      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // *** PASTE YOUR DEPLOYED URL HERE ***
  const API_URL = "https://script.google.com/macros/s/AKfycbzOk6hCXbs51Hddw322AY4wMyw6xYQxK2O_uh6ui28pU4BsiOmtLsLBjSC0Od7igvjH/exec";

  const userId = sessionStorage.getItem('userId');
  const role = sessionStorage.getItem('role');
  if(role !== 'Admin') window.location.href = 'index.html';

  let allUsers = [];
  let currentUserToEdit = null;
  
  // PAGINATION VARS
  let currentPage = 1;
  let rowsPerPage = 20;

  window.onload = fetchUsers;

  function fetchUsers() {
    fetch(`${API_URL}?action=getAllUsers`)
      .then(res => res.json())
      .then(data => {
        allUsers = data;
        renderTable();
      });
  }

  function handleSearch() {
      currentPage = 1; // Reset to page 1 on search
      renderTable();
  }

  function changeRowsPerPage() {
      rowsPerPage = parseInt(document.getElementById('rowsPerPage').value);
      currentPage = 1; // Reset to page 1
      renderTable();
  }

  function changePage(direction) {
      currentPage += direction;
      renderTable();
  }

  function renderTable() {
    const search = document.getElementById('searchUser').value.toLowerCase();
    const tbody = document.getElementById('userTableBody');
    tbody.innerHTML = '';

    // 1. Filter Data
    const filtered = allUsers.filter(u => 
      (u.userId && u.userId.toLowerCase().includes(search)) || 
      (u.empId && u.empId.toString().toLowerCase().includes(search)) ||
      (u.email && u.email.toLowerCase().includes(search))
    );

    // 2. Pagination Logic
    const totalRows = filtered.length;
    const startIndex = (currentPage - 1) * rowsPerPage;
    const endIndex = Math.min(startIndex + rowsPerPage, totalRows);
    
    // Slice data for current page
    const pageData = filtered.slice(startIndex, endIndex);

    // Update Pagination UI Info
    document.getElementById('startRow').innerText = totalRows > 0 ? startIndex + 1 : 0;
    document.getElementById('endRow').innerText = endIndex;
    document.getElementById('totalRows').innerText = totalRows;
    
    // Disable/Enable Buttons
    document.getElementById('btnPrev').disabled = currentPage === 1;
    document.getElementById('btnNext').disabled = endIndex >= totalRows;

    // 3. Render Rows
    if(totalRows === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">No users found.</td></tr>';
      return;
    }

    pageData.forEach(u => {
      const isActive = u.status === 'Active';
      const statusBadge = isActive ? '<span class="badge-status bg-active">Active</span>' : '<span class="badge-status bg-inactive">Inactive</span>';
      
      const toggleBtn = isActive 
        ? `<button class="btn btn-sm btn-outline-warning" title="Deactivate" onclick="event.stopPropagation(); changeStatus('${u.userId}', 'Inactive')"><i class="fas fa-ban"></i></button>`
        : `<button class="btn btn-sm btn-outline-success" title="Activate" onclick="event.stopPropagation(); changeStatus('${u.userId}', 'Active')"><i class="fas fa-check"></i></button>`;

      tbody.innerHTML += `
        <tr class="clickable-row" onclick="openEditModal('${u.userId}')">
          <td class="ps-4">
            <div class="fw-bold text-dark">${u.userId}</div>
            <div class="small text-muted">${u.email}</div>
          </td>
          <td class="text-muted fw-bold small">${u.empId || '-'}</td>
          <td class="text-muted small">${u.phone || '-'}</td>
          <td><span class="badge bg-light text-dark border">${u.role}</span></td>
          <td>${statusBadge}</td>
          <td class="text-end pe-4">
             ${toggleBtn}
             <button class="btn btn-sm btn-outline-danger ms-1" title="Delete" onclick="event.stopPropagation(); deleteUser('${u.userId}')"><i class="fas fa-trash"></i></button>
          </td>
        </tr>
      `;
    });
  }

  // --- OPEN USER MODAL ---
  function openEditModal(uid) {
    const u = allUsers.find(x => x.userId === uid);
    if(!u) return;

    currentUserToEdit = uid;
    document.getElementById('editUserName').innerText = u.userId; 
    document.getElementById('editUserId').innerText = u.empId || '';
    document.getElementById('editUserEmail').innerText = u.email;
    document.getElementById('editEmpId').innerText = u.empId || '-';
    document.getElementById('editUserPhone').innerText = u.phone || '-';
    document.getElementById('editUserRole').innerText = u.role;
    
    hideResetInput();
    new bootstrap.Modal(document.getElementById('editUserModal')).show();
  }

  function showResetInput() {
    document.getElementById('resetSection').classList.add('d-none');
    document.getElementById('resetInputDiv').classList.remove('d-none');
    document.getElementById('newResetPass').value = '';
  }

  function hideResetInput() {
    document.getElementById('resetSection').classList.remove('d-none');
    document.getElementById('resetInputDiv').classList.add('d-none');
  }

  function confirmResetPassword() {
    const newPass = document.getElementById('newResetPass').value;
    if(!newPass) { alert("Please enter a password"); return; }
    
    const btn = document.getElementById('savePassBtn');
    btn.disabled = true; btn.innerText = "Saving...";

    fetch(API_URL, { 
      method: 'POST', 
      body: JSON.stringify({ action: 'manageUser', type: 'resetPassword', userId: currentUserToEdit, newPassword: newPass }) 
    })
    .then(res => res.json())
    .then(data => {
      if(data.success) {
        alert("Password Updated Successfully!");
        hideResetInput();
      } else {
        alert("Error: " + data.message);
      }
    })
    .finally(() => { btn.disabled = false; btn.innerText = "Save"; });
  }

  // --- ADD USER ---
  document.getElementById('addUserForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const btn = document.getElementById('addBtn');
    btn.disabled = true; btn.innerText = "Processing...";

    const payload = {
      action: 'manageUser',
      type: 'add',
      userId: document.getElementById('newUserName').value, 
      empId: document.getElementById('newEmpId').value,
      email: document.getElementById('newUserEmail').value,
      phone: document.getElementById('newUserPhone').value,
      password: document.getElementById('newUserPass').value,
      role: document.getElementById('newUserRole').value
    };

    fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) })
      .then(res => res.json())
      .then(data => {
        if(data.success) {
          alert("User Added Successfully!");
          bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
          document.getElementById('addUserForm').reset();
          fetchUsers();
        } else {
          alert("Error: " + data.message);
        }
      })
      .finally(() => { btn.disabled = false; btn.innerText = "Create User"; });
  });

  // --- CHANGE STATUS ---
  function changeStatus(uid, newStatus) {
    if(!confirm(`Are you sure you want to make ${uid} ${newStatus}?`)) return;

    fetch(API_URL, { 
      method: 'POST', 
      body: JSON.stringify({ action: 'manageUser', type: 'status', userId: uid, newStatus: newStatus }) 
    })
    .then(res => res.json())
    .then(data => {
      if(data.success) fetchUsers();
      else alert("Failed to update status");
    });
  }

  // --- DELETE USER ---
  function deleteUser(uid) {
    if(!confirm(`⚠️ DANGER: Are you sure you want to PERMANENTLY DELETE ${uid}?`)) return;

    fetch(API_URL, { 
      method: 'POST', 
      body: JSON.stringify({ action: 'manageUser', type: 'delete', userId: uid }) 
    })
    .then(res => res.json())
    .then(data => {
      if(data.success) fetchUsers();
      else alert("Failed to delete user");
    });
  }

  function logout() { sessionStorage.clear(); window.location.href = 'index.html'; }
</script>

</body>
</html>
